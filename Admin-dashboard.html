<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FitFuel - Admin Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <script src="app.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #f4b400; color: white; }
    .btn { padding: 5px 10px; margin: 2px; cursor: pointer; border: none; border-radius: 4px; }
    .btn-add { background: green; color: white; }
    .btn-remove { background: red; color: white; }
    .btn-delete { background: darkred; color: white; }
    .btn-link { background: #333; color: white; }
    .btn-edit { background: #0ea5e9; color: white; }
    .form-row { display:flex; gap:10px; margin: 6px 0; }
    .form-row input { flex:1; padding:8px; border:1px solid #ddd; border-radius:6px; }
  </style>
</head>
<body>
  <header>
    <h1>Admin Panel</h1>
    <nav>
      <button class="btn btn-link" onclick="window.location.href='user-dashboard.html'">User Dashboard</button>
      <button class="btn btn-link" onclick="window.location.href='products.html'">Products</button>
      <a href="#" onclick="logout()" class="btn btn-link">Logout</a>
    </nav>
  </header>

  <!-- Product Management (API-backed) -->
  <section>
    <h2>Product Management</h2>
    <div id="product-form">
      <div class="form-row">
        <input id="p-name" placeholder="Name" />
        <input id="p-price" type="number" placeholder="Price" />
      </div>
      <div class="form-row">
        <input id="p-category" placeholder="Category (e.g., protein)" />
        <input id="p-image" placeholder="Image URL (optional)" />
      </div>
      <div class="form-row">
        <input id="p-desc" placeholder="Description" />
        <input id="p-stock" type="number" placeholder="Stock" />
      </div>
      <button class="btn btn-add" onclick="createProduct()">Create Product</button>
    </div>
    <div id="product-list" style="margin-top: 10px;"></div>
  </section>

  <!-- Wallet Overview -->
  <section>
    <h2>Wallet Overview</h2>
    <div id="wallet-section" class="wallet-container"></div>
  </section>

  <!-- Order Management -->
  <section>
    <h2>Order Management</h2>
    <div id="order-section"></div>
  </section>

  <!-- User Management -->
  <section>
    <h2>User Management</h2>
    <div id="user-section"></div>
  </section>

  <script>
    // Restrict access by role (requires login + admin role)
    (function guard() {
      const u = JSON.parse(localStorage.getItem('fitfuel_user') || 'null');
      if (!u || u.role !== 'admin') {
        alert('Access denied! Only admins can view this page.');
        window.location.href = 'login.html';
      }
    })();

    // -------- PRODUCT MANAGEMENT (API) --------
    async function loadProducts() {
      const container = document.getElementById('product-list');
      container.innerHTML = 'Loading products...';
      try {
        const { items } = await apiListProducts({ pageSize: 100 });
        if (!items || items.length === 0) { container.innerHTML = 'No products found'; return; }
        const rows = items.map(p => `
          <tr>
            <td>${p.name}</td>
            <td>₹${p.price}</td>
            <td>${p.category || ''}</td>
            <td>${p.stock ?? 0}</td>
            <td>
              <button class="btn btn-edit" onclick="editProduct('${p._id}', ${p.price}, ${p.stock ?? 0})">Edit</button>
              <button class="btn btn-delete" onclick="deleteProduct('${p._id}')">Delete</button>
            </td>
          </tr>
        `).join('');
        container.innerHTML = `
          <table>
            <tr><th>Name</th><th>Price</th><th>Category</th><th>Stock</th><th>Actions</th></tr>
            ${rows}
          </table>
        `;
      } catch (e) {
        container.innerHTML = '<span style="color:red;">Failed to load products</span>';
      }
    }

    async function createProduct() {
      try {
        const name = document.getElementById('p-name').value.trim();
        const price = parseFloat(document.getElementById('p-price').value);
        const category = document.getElementById('p-category').value.trim();
        const image = document.getElementById('p-image').value.trim();
        const description = document.getElementById('p-desc').value.trim();
        const stock = parseInt(document.getElementById('p-stock').value) || 0;
        if (!name || isNaN(price)) { alert('Name and price are required'); return; }
        const images = image ? [image] : [];
        await authFetch('/products', { method: 'POST', body: JSON.stringify({ name, price, category, images, description, stock }) });
        alert('Product created');
        loadProducts();
      } catch (e) {
        alert('Failed: ' + (e.message || 'error'));
      }
    }

    async function editProduct(id, price, stock) {
      const newPrice = parseFloat(prompt('New price:', price));
      if (isNaN(newPrice)) return;
      const newStock = parseInt(prompt('New stock:', stock));
      if (isNaN(newStock)) return;
      try {
        await authFetch(`/products/${id}`, { method: 'PUT', body: JSON.stringify({ price: newPrice, stock: newStock }) });
        alert('Updated');
        loadProducts();
      } catch (e) {
        alert('Failed: ' + (e.message || 'error'));
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Delete this product?')) return;
      try {
        await authFetch(`/products/${id}`, { method: 'DELETE' });
        loadProducts();
      } catch (e) {
        alert('Failed: ' + (e.message || 'error'));
      }
    }

    document.addEventListener('DOMContentLoaded', loadProducts);

    // ---------------- WALLET MANAGEMENT ----------------
    let allWallets = JSON.parse(localStorage.getItem("fitfuel_wallets")) || [];
    if (allWallets.length === 0) {
      allWallets = [
        { username: "John", ffCash: 500, lastUpdated: "2025-09-01" },
        { username: "Emma", ffCash: 300, lastUpdated: "2025-09-03" },
        { username: "Mike", ffCash: 200, lastUpdated: "2025-09-04" }
      ];
      localStorage.setItem("fitfuel_wallets", JSON.stringify(allWallets));
    }

    function updateWallets() {
      let totalCash = allWallets.reduce((sum, w) => sum + w.ffCash, 0);
      let tableRows = allWallets.map((u, i) => `
        <tr>
          <td>${u.username}</td>
          <td>₹${u.ffCash}</td>
          <td>${u.lastUpdated}</td>
          <td>
            <button class="btn btn-add" onclick="addCash(${i})">+100</button>
            <button class="btn btn-remove" onclick="removeCash(${i})">-100</button>
          </td>
        </tr>
      `).join("");

      document.getElementById("wallet-section").innerHTML = `
        <h3>Total FF Cash: ₹${totalCash}</h3>
        <table>
          <tr><th>User</th><th>FF Cash</th><th>Last Updated</th><th>Actions</th></tr>
          ${tableRows}
        </table>
      `;
      localStorage.setItem("fitfuel_wallets", JSON.stringify(allWallets));
    }

    function addCash(i) {
      allWallets[i].ffCash += 100;
      allWallets[i].lastUpdated = new Date().toISOString().split("T")[0];
      updateWallets();
    }

    function removeCash(i) {
      if (allWallets[i].ffCash >= 100) {
        allWallets[i].ffCash -= 100;
        allWallets[i].lastUpdated = new Date().toISOString().split("T")[0];
        updateWallets();
      } else {
        alert("Not enough balance!");
      }
    }

    updateWallets();

    // ---------------- ORDER MANAGEMENT (API) ----------------
    async function loadAllOrders() {
      const container = document.getElementById('order-section');
      container.innerHTML = 'Loading orders...';
      try {
        const orders = await authFetch('/orders/all');
        if (!orders || orders.length === 0) {
          container.innerHTML = 'No orders found';
          return;
        }
        const rows = orders.map(o => {
          const items = (o.items || []).map(i => `${i.name} x ${i.quantity}`).join(', ');
          const created = new Date(o.createdAt).toLocaleString();
          return `
            <tr>
              <td>${o._id}</td>
              <td>${o.userId}</td>
              <td>${items}</td>
              <td>₹${o.total}</td>
              <td>${created}</td>
              <td>
                <select data-id="${o._id}">
                  ${['placed','processing','shipped','delivered','cancelled'].map(s => `<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join('')}
                </select>
                <button class="btn btn-edit" data-action="save" data-id="${o._id}">Save</button>
              </td>
            </tr>`;
        }).join('');
        container.innerHTML = `
          <table>
            <tr><th>Order ID</th><th>User</th><th>Items</th><th>Total</th><th>Date</th><th>Status</th></tr>
            ${rows}
          </table>
        `;
        container.querySelectorAll('button[data-action="save"]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            const sel = container.querySelector(`select[data-id="${id}"]`);
            const status = sel.value;
            try {
              await authFetch(`/orders/${id}/status`, { method: 'PATCH', body: JSON.stringify({ status }) });
              alert('Status updated');
            } catch (e) {
              alert('Failed: ' + (e.message || 'error'));
            }
          });
        });
      } catch (e) {
        container.innerHTML = '<span style="color:red;">Failed to load orders</span>';
      }
    }

    // ---------------- USER MANAGEMENT (API) ----------------
    async function loadUsers() {
      const container = document.getElementById('user-section');
      container.innerHTML = 'Loading users...';
      try {
        const users = await authFetch('/users');
        if (!users || users.length === 0) { container.innerHTML = 'No users found'; return; }
        const rows = users.map(u => `
          <tr>
            <td>${u.name || u.email || u._id}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
          </tr>
        `).join('');
        container.innerHTML = `
          <table>
            <tr><th>Name</th><th>Email</th><th>Role</th></tr>
            ${rows}
          </table>
        `;
      } catch (e) {
        container.innerHTML = '<span style="color:red;">Failed to load users</span>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAllOrders();
      loadUsers();
    });
  </script>
</body>
</html>
