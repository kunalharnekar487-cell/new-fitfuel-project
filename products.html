<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FitFuel - Products</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="app.js"></script>
</head>
<body class="bg-gray-100">

  <!-- Header -->
  <header class="bg-white shadow-md p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-indigo-600">FitFuel</h1>
    <nav class="flex items-center space-x-6">
      <a href="index.html" class="hover:text-indigo-600">Home</a>
      <a href="products.html" class="hover:text-indigo-600">Products</a>
      <a href="lab-reports.html" class="hover:text-indigo-600">Lab Reports</a>
      <a href="wallet.html" class="hover:text-indigo-600">Wallet</a>
      <a href="orders.html" class="hover:text-indigo-600">My Orders</a>
      <a href="cart.html" class="hover:text-indigo-600 relative">Cart <span id="cart-count" class="absolute -top-2 -right-4 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">0</span></a>
      <a id="auth-login-link" href="login.html" class="hover:text-indigo-600">Login</a>
      <span id="auth-user-name" class="text-sm text-gray-600"></span>
      <a id="auth-logout-link" href="#" onclick="logout()" style="display:none" class="hover:text-indigo-600">Logout</a>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto mt-6 flex space-x-6">

    <!-- Sidebar Filters -->
    <aside class="w-1/4 bg-white shadow-md rounded-lg p-4">
      <h2 class="text-lg font-semibold mb-4">Filters</h2>

      <!-- Search -->
      <div class="mb-4">
        <input id="search" type="text" placeholder="Search products..." class="w-full px-3 py-2 border rounded">
      </div>
      <button id="resetFilters" class="text-sm text-gray-500 border px-3 py-1 rounded mb-4">RESET</button>

      <!-- Working Filter Controls -->
      <div class="space-y-4 text-sm">
        <!-- Sort By -->
        <div>
          <div class="flex justify-between items-center border-b pb-2 font-semibold">SORT BY</div>
          <select id="sort" class="mt-2 w-full border rounded px-2 py-1">
            <option value="relevance">Relevance</option>
            <option value="price_asc">Price: Low to High</option>
            <option value="price_desc">Price: High to Low</option>
            <option value="rating_desc">Rating: High to Low</option>
            <option value="name_asc">Name: A → Z</option>
          </select>
        </div>

        <!-- Ratings -->
        <div>
          <div class="flex justify-between items-center border-b pb-2 font-semibold">RATINGS</div>
          <select id="rating" class="mt-2 w-full border rounded px-2 py-1">
            <option value="0">Any</option>
            <option value="4">4★ & up</option>
            <option value="4.5">4.5★ & up</option>
            <option value="5">5★ only</option>
          </select>
        </div>

        <!-- Stock -->
        <div>
          <div class="flex justify-between items-center border-b pb-2 font-semibold">STOCK AVAILABILITY</div>
          <label class="mt-2 inline-flex items-center gap-2 text-sm"><input id="inStock" type="checkbox" class="accent-indigo-600"> In stock only</label>
        </div>

        <!-- Price Range (dual) -->
        <div>
          <div class="flex justify-between items-center border-b pb-2 font-semibold">PRICE</div>
          <div class="mt-3 grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-gray-500">Min</label>
              <input id="priceMin" type="number" class="w-full border rounded px-2 py-1" placeholder="₹ Min">
            </div>
            <div>
              <label class="text-xs text-gray-500">Max</label>
              <input id="priceMax" type="number" class="w-full border rounded px-2 py-1" placeholder="₹ Max">
            </div>
          </div>
          <div class="mt-2">
            <input id="priceRange" type="range" min="0" max="100" value="100" class="w-full">
            <p id="priceLabel" class="text-xs text-gray-600 mt-1"></p>
          </div>
        </div>
      </div>
    </aside>

    <!-- Products Area -->
    <section class="w-3/4 flex flex-col">
      <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-6"></div>
      <div id="pagination" class="mt-6 flex items-center justify-center gap-3"></div>
    </section>
  </main>

  <script>
    let currentPage = 1;
    const pageSize = 12;
    let allItems = [];

    function renderPagination(total) {
      const totalPages = Math.max(Math.ceil(total / pageSize), 1);
      const nav = document.getElementById('pagination');
      if (!nav) return;
      nav.innerHTML = '';
      const prev = document.createElement('button');
      prev.textContent = 'Prev';
      prev.disabled = currentPage <= 1;
      prev.className = 'px-3 py-1 border rounded mr-2 disabled:opacity-50';
      prev.onclick = () => { if (currentPage > 1) { currentPage--; renderProducts(); } };
      const next = document.createElement('button');
      next.textContent = 'Next';
      next.disabled = currentPage >= totalPages;
      next.className = 'px-3 py-1 border rounded ml-2 disabled:opacity-50';
      next.onclick = () => { if (currentPage < totalPages) { currentPage++; renderProducts(); } };
      const info = document.createElement('span');
      info.className = 'text-sm text-gray-600 mx-2';
      info.textContent = `Page ${currentPage} of ${totalPages}`;
      nav.appendChild(prev);
      nav.appendChild(info);
      nav.appendChild(next);
    }

    async function renderProducts() {
      const grid = document.getElementById('products-grid');
      const search = document.getElementById('search').value.trim();
      grid.innerHTML = '<div class="col-span-full text-center text-gray-500">Loading...</div>';
      try {
        // Fetch a large page and filter client-side so filters work without backend changes
        if (!allItems.length) {
          const { items } = await apiListProducts({ search: '', page: 1, pageSize: 500 });
          allItems = items || [];
        }
        // Filter pipeline
        let filtered = allItems.slice();
        if (search) {
          const q = search.toLowerCase();
          filtered = filtered.filter(p => (p.name||'').toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q));
        }
        // Rating
        const minRating = parseFloat(document.getElementById('rating').value || '0');
        if (minRating > 0) filtered = filtered.filter(p => (p.rating||0) >= minRating);
        // In stock
        if (document.getElementById('inStock').checked) filtered = filtered.filter(p => (p.stock||0) > 0);
        // Price
        const minPrice = parseFloat(document.getElementById('priceMin').value || '0');
        const maxPrice = parseFloat(document.getElementById('priceMax').value || '999999');
        filtered = filtered.filter(p => p.price >= minPrice && p.price <= maxPrice);
        // Sort
        const sort = document.getElementById('sort').value;
        const sorters = {
          relevance: () => 0,
          price_asc: (a,b) => a.price - b.price,
          price_desc: (a,b) => b.price - a.price,
          rating_desc: (a,b) => (b.rating||0) - (a.rating||0),
          name_asc: (a,b) => String(a.name).localeCompare(String(b.name)),
        };
        filtered.sort(sorters[sort] || sorters.relevance);

        // Pagination
        const total = filtered.length;
        const start = (currentPage - 1) * pageSize;
        const pageItems = filtered.slice(start, start + pageSize);

        if (pageItems.length === 0) {
          grid.innerHTML = '<div class="col-span-full text-center text-gray-400">No products found</div>';
          renderPagination(0);
          return;
        }
        grid.innerHTML = '';
        pageItems.forEach(p => {
          const img = (typeof productImageUrl === 'function' ? productImageUrl(p, '400x400') : ((p.images && p.images[0]) || 'https://placehold.co/400x400?text=Product'));
          const card = document.createElement('div');
          card.className = 'bg-white p-4 shadow-md rounded-lg flex flex-col h-[420px]';
          const imageBlock = `<img src="${img}" alt="${p.name}" class="w-full aspect-square object-cover rounded cursor-pointer" data-id="${p._id}" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Product'">`;
          card.innerHTML = `
            ${imageBlock}
            <h3 class="mt-3 font-semibold">${p.name}</h3>
            <p class="text-sm text-gray-600 line-clamp-2">${p.description || ''}</p>
            <p class="mt-1 font-bold">₹${p.price}</p>
            <div class="mt-auto flex justify-between pt-3">
              <button class="bg-indigo-600 text-white px-3 py-1 rounded">Add to Cart</button>
              <button class="border border-indigo-600 text-indigo-600 px-3 py-1 rounded">View</button>
            </div>
          `;
          card.querySelector('button').addEventListener('click', () => addToCart(p.name, p.price, img || undefined, p._id, 1));
          card.querySelectorAll('[data-id], .border').forEach(el => el.addEventListener('click', () => {
            location.href = `product.html?id=${p._id}`;
          }));
          grid.appendChild(card);
        });
        renderPagination(total);
        try { fixPlaceholderImages && fixPlaceholderImages(); } catch {}
      } catch (e) {
        console.error(e);
        grid.innerHTML = '<div class="col-span-full text-center text-red-500">Failed to load products</div>';
        renderPagination(0);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      updateCartCount();
      await renderProducts();
      // Initialize price UI from data
      if (allItems.length) {
        const prices = allItems.map(p => p.price);
        const min = Math.min(...prices), max = Math.max(...prices);
        const minInput = document.getElementById('priceMin');
        const maxInput = document.getElementById('priceMax');
        const range = document.getElementById('priceRange');
        const label = document.getElementById('priceLabel');
        minInput.value = min;
        maxInput.value = max;
        range.min = String(min);
        range.max = String(max);
        range.value = String(max);
        label.textContent = `₹${min} - ₹${range.value}`;
        range.addEventListener('input', () => {
          maxInput.value = range.value;
          label.textContent = `₹${minInput.value} - ₹${range.value}`;
          currentPage = 1; renderProducts();
        });
        const onNumChange = () => { label.textContent = `₹${minInput.value||min} - ₹${maxInput.value||max}`; currentPage = 1; renderProducts(); };
        minInput.addEventListener('change', onNumChange);
        maxInput.addEventListener('change', onNumChange);
      }
      // Live search debounce
      document.getElementById('search').addEventListener('input', () => {
        clearTimeout(window.__searchTimer);
        window.__searchTimer = setTimeout(() => { currentPage = 1; renderProducts(); }, 300);
      });
      // Other filters
      document.getElementById('rating').addEventListener('change', () => { currentPage = 1; renderProducts(); });
      document.getElementById('inStock').addEventListener('change', () => { currentPage = 1; renderProducts(); });
      document.getElementById('sort').addEventListener('change', () => { currentPage = 1; renderProducts(); });
      // Reset button
      document.getElementById('resetFilters').addEventListener('click', () => {
        document.getElementById('search').value = '';
        document.getElementById('rating').value = '0';
        document.getElementById('inStock').checked = false;
        document.getElementById('sort').value = 'relevance';
        const prices = allItems.map(p => p.price);
        const min = Math.min(...prices), max = Math.max(...prices);
        document.getElementById('priceMin').value = min;
        document.getElementById('priceMax').value = max;
        const range = document.getElementById('priceRange');
        range.min = String(min); range.max = String(max); range.value = String(max);
        document.getElementById('priceLabel').textContent = `₹${min} - ₹${max}`;
        currentPage = 1;
        renderProducts();
      });
    });
  </script>

</body>
</html>
